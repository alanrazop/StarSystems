<%- include('partials/head.ejs'); -%>
  <%- include('partials/navbar-top.ejs'); -%>
    <%- include('partials/sidebar.ejs'); -%>
    
      <div class="columns is-desktop">
        <div class="column">
          <div class="box">
            <div class="content">
              <div class="level">
                <h1>Tareas recientes</h1>
              <div class="field is-pulled-right">
                <a href="#" class="button is-rounded is-medium is-link is-pulled-right js-modal-trigger"
                data-target="modal-js-example">
                  <span class="icon is-small">
                    <i class="fa-solid fa-file-circle-plus"></i></span>
                  <span>Agregar tarea</span>
                </a>
              </div>
              </div>
            </div>
   
            <p class="control has-icons-left">
              <input class="input is-rounded has-background-light" type="text" placeholder="Buscar">
              <span class="icon is-small is-left">
                <i class="fas fa-search"></i>
              </span>
            </p>
          </div>
        </div>
      </div>
    <div class="block">
      <%- include('partials/table.ejs'); -%>
    </div>
        
        

       <!-- --- Modal de agregar tarea --- -->

      <form id="formTareas" class="was-validated" action="/home/tareas" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" >
        <div id="modal-js-example" class="modal">
          <div class="modal-background"></div>
        
          <div class="modal-card">
            <header class="modal-card-head">
              <p class="modal-card-title">Agregar tarea</p>
              <button class="delete" aria-label="close"></button>
            </header>

            <section class="modal-card-body">
              <!-- Content ... -->

                <div class="field is-horizontal">
                  <div class="field-label is-normal">
                    <label class="label">Descripción: </label>
                  </div>
                  <div class="field-body">
                    <div class="field">
                      <p class="control">
                        <textarea name="descripcion" class="textarea" placeholder="Describe la actividad que realizaste" required></textarea>
                    </div>
                  </div>
                  
                </div>
                <div class="field is-horizontal">
                  <div class="field-label is-normal">
                    <label class="label">Proyecto: </label>
                  </div>
                  <div class="field-body">
                    <div class="field">
                      <p class="control">
                        <div class="select">
                          <select  class="form-select" name = "select_proyecto" id = "select_proyecto"  onchange="getValue(this);" required>
                            <option  value = "" selected >Selecciona un proyecto</option>
                            w<% for (let p of proyectos) { %>
                            <option value = "<%= p.id_proyecto %>"> <%= p.nombre_proyecto %></option>
                            <% } %>
                          </select> 
                        </div>
                    </div>
                  </div>
                </div>
                <div class="field is-horizontal">
                  <div class="field-label is-normal">
                    <label class="label">Horas: </label>
                  </div>
                  <div class="field-body">
                    <div class="field">
                      <p class="control">
                        <input class="input" id = "input_horas" name = "input_horas" type="number" placeholder="" min="0" required>
                      </p>
                    </div>
                  </div>
                </div>
                <div class="field is-horizontal">
                  <div class="field-label is-normal">
                    <label class="label">Colaboradores: </label>
                  </div>

                  <div class="field-body">
                    <div class="field">
                      <p class="control">
                        <div>
                          <% for (let e of empleados) { %>
                            <label>
                              <input type="checkbox" name = "check_empleados" id="check_empleados" value="<%= e.id_empleado %>"> <%= e.nombre %> </label> <br> 
                            <% } %>
                               
                        </div>
    
                    </div>
                  </div>
                </div>

                <div class="field is-horizontal">
                  <div class="field-label is-normal">
                    <label class="label">Fecha de registro: </label>
                  </div>
                  <div class="field-body">
                    <div class="field">
                      <p class="control">
                      <input class="input" type="date" id="fecha_act" name="fecha_act" required>
                    </div>
                  </div>
                </div>
              </form>
            </section>
            <footer class="modal-card-foot">
              <button class="button is-success" type="submit" id="buttonRegistrar" required > Guardar tarea </button>
              <button class="button" onclick="alertaCancelado();">Cancelar</button>
          </div>         
          </div>
          <button class="modal-close is-large" aria-label="close" ></button>
        </div>
      </footer> 
      <script>
        document.addEventListener('DOMContentLoaded', () => {
        // Functions to open and close a modal
        function openModal($el) {
          $el.classList.add('is-active');
        }

        function closeModal($el) {
          $el.classList.remove('is-active');
        }

        function closeAllModals() {
          (document.querySelectorAll('.modal') || []).forEach(($modal) => {
            closeModal($modal);
          });
        }

        // Add a click event on buttons to open a specific modal
        (document.querySelectorAll('.js-modal-trigger') || []).forEach(($trigger) => {
          const modal = $trigger.dataset.target;
          const $target = document.getElementById(modal);

          $trigger.addEventListener('click', () => {
            openModal($target);
          });
        });

        // Add a click event on various child elements to close the parent modal
        (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button') || []).forEach(($close) => {
          const $target = $close.closest('.modal');

          $close.addEventListener('click', () => {
            closeModal($target);
          });
        });

        // Add a keyboard event to close all modals
        document.addEventListener('keydown', (event) => {
          const e = event || window.event;

          if (e.keyCode === 27) { // Escape key
            closeAllModals();
          }
        });
      });
     
        document.getElementById('buttonRegistrar').addEventListener('click', () => {
          Swal.fire({
            icon: 'success',
            title: 'Tarea registrada con éxito'
          })
        });

      </script> 

      
<script>
  const accion_asincrona = () => {
    const valor = document.getElementById('buscar_actividad').value;

    //función que manda la petición asíncrona
    fetch('/home/tareas/buscar/' + valor, {
        method: 'GET'
    }).then(result => {
        return result.json(); //Regresa otra promesa
    }).then(data => {
        //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
        console.log(data);
        let html = '';

        if (data.empleados.length > 0) {
          html += '<div class="card">'
          for ( e of data.empleados) {
            html += '<div class="column is-half">';
            html += '<div class="card-content">'
            html += '<table class="table is-fullwidth">';
            html += '<thead>';
            html += '<tr>';
            html += '<th>Proyecto</th>';
            html += '<th>Actividad</th>';
            html += '<th>Duración</th>';
            html += '<th>Colaboradores</th>';
            html += '<th>Fecha</th>';
            html += '</tr>';
            html += '</thead>';
            html += ' <tbody>';
            html += 'for (let a of actividades) {';
            html += ' let array = String(a.fecha).split(" ")';
            html += '<tr>';
            html += '<td> a.nombre_proyecto';
            html += '<td>';
            html += ' <p> a.descripcion_actividad </p>';
            html += '</td>';
            html += ' <td> a.num_horas.toFixed(1)</td>';
            html += '<td>';
            html += '  <div class="columns is-multiline is-gapless">';
            for (let participante of a.participantes) { 
              html +=  '<div class="column is-one-quarter mx-0">';
              html +=    '<span class="icon-text">';
                html +=    '<span class="icon">';
                  html +=     ' <i class="fa-solid fa-circle-user"></i>';
                  html +=  ' </span>';
                html +=   ' <span> participante.nombre </span>';
                html +=' </span>';
              html += '</div>';
           }
           html += '</div>';
           html += ' </td>';
           html += ' <td> array[2] + "-" + array[1] + "-" + array[3] </td> ';
           html += '  <td>';
           html += '<form action="/home/delete" method="POST">';
           html += ' <input type="hidden" name="_csrf" value=" csrfToken " >';
           html += ' <a class="button is-black is-light" href="/home/edit/ a.id_actividad "><span class="icon"><i class="fas fa-edit"></i></span></a>';
           html += ' <input id="id" name="id" type="hidden" value="a.id_actividad"> &nbsp;';
           html += ' <a class="button is-danger is-light js-modal-trigger" data-target="delete a.id_actividad"><span class="icon"><i class="fa-solid fa-trash-can"></i></span></a>';
           html += '<div id="delete a.id_actividad " class="modal">';
           html += ' <div class="modal-background"></div>';
           html += '<div class="modal-content">';
           html += ' <div class="box">';
           html += ' <p class="title">¿Desea eliminar la tarea?</p>';
           html += ' <input type="submit" class="button is-danger" value="Eliminar tarea">';
           html += '  </div>';
           html += '  </div>';
           html += ' </div>';
           html += ' </form>';
           html += ' </td>';
           html += ' </tr>';
          }
    html += '  </tbody>';
    html += '   </table>';
    html += '   </div>';
    html += '   </div>';
        }
      
        else {
          html = '<h2>No hay actividades registradas que coincidan con la búsqueda</h2>';
        }
        document.getElementById('lista_empleados').innerHTML = html;
        
    }).catch(err => {
        console.log(err);
    });
  };
  document.getElementById('buscar_actividad').onkeyup = accion_asincrona;
</script>
        <%- include('partials/tail.ejs'); -%>
